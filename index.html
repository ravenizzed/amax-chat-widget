<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AMAX BI Assistant</title>
  <meta name="description" content="AMAX Insurance Business Intelligence Assistant - AI-powered data analysis and reporting">
  <meta name="keywords" content="AMAX, insurance, business intelligence, AI assistant, data analysis">

  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">

  <link rel="icon" type="image/png" href="./assets/amax-logo-favi-icon.png">
  <link rel="shortcut icon" href="./assets/amax-logo-favi-icon.png">

  <style>
    /* Reset & page styling */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: transparent;
      min-height: 100vh;
      overflow: hidden;
    }
    .page-content { display: none; }

    /* --- Loading and Fallback UI --- */

    /* Emergency button is hidden by default */
    .emergency-button {
      position: fixed; bottom: 25px; right: 25px;
      width: 65px; height: 65px;
      background: linear-gradient(135deg, #DC143C 0%, #B91C1C 100%);
      border: none; border-radius: 50%;
      cursor: pointer; z-index: 999998;
      display: none; /* Hidden by default */
      align-items: center; justify-content: center;
      box-shadow: 0 8px 32px rgba(220,20,60,0.4);
      transition: all .3s ease;
    }
    .emergency-button:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 12px 40px rgba(220,20,60,0.6);
    }
    .emergency-button img { width: 32px; height: 32px; object-fit: contain; }

    /* When widget fails, show the emergency button */
    body.widget-failed .emergency-button {
      display: flex !important;
    }

    /* Loading indicator is visible by default */
    .loading-indicator {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 999997;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .loading-spinner {
      width: 24px; height: 24px;
      border: 2px solid #e5e7eb; border-top: 2px solid #DC143C;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% {transform:rotate(0);} 100% {transform:rotate(360deg);} }

    /* Hide the loader once the widget script has loaded and created the button */
    body.widget-loaded .loading-indicator {
      display: none !important;
    }
  </style>
</head>

<body>
  <div class="loading-indicator" id="loadingIndicator">
    <div class="loading-spinner"></div>
    <div>Loading AMAX BI Assistant...</div>
  </div>

  <button class="emergency-button" id="emergencyBtn" onclick="window.widgetUI.openWidget()" title="Open AMAX BI Assistant">
    <img src="./assets/amax-logo-A.png" alt="AMAX" onerror="this.style.display='none'; this.parentNode.innerHTML='A';">
  </button>

  <div class="page-content">
    <h1>AMAX Insurance BI Assistant</h1>
    <p>AI-powered business intelligence and data analysis for AMAX Insurance.</p>
  </div>

  <script>
    console.log('AMAX Index.html loading...');

    // iframe detection
    if (window.self !== window.top) {
      document.body.classList.add('iframe-mode');
      console.log('Running in iframe mode');
    }

    // --- Reworked Widget Load Detection ---
    (function() {
      let attempts = 0;
      const maxAttempts = 15; // Increased attempts to 15 seconds for slower connections
      const interval = 1000;

      const widgetCheck = setInterval(() => {
        const widgetButton = document.getElementById('amaxWidgetBtn');

        if (widgetButton) {
          // SUCCESS: Widget button is found
          console.log(`✅ Widget loaded successfully after ${attempts + 1} second(s).`);
          document.body.classList.add('widget-loaded');
          clearInterval(widgetCheck);
        } else {
          // NOT FOUND: Increment and check again
          attempts++;
          console.log(`Checking for widget… attempt ${attempts}`);
          if (attempts >= maxAttempts) {
            // FAILURE: Max attempts reached
            console.error('❌ Widget failed to load after 15 seconds.');
            clearInterval(widgetCheck);
            document.body.classList.add('widget-loaded'); // Hide the loader
            document.body.classList.add('widget-failed'); // Show the emergency button
          }
        }
      }, interval);
    })();

    // --- Parent <-> Widget Messaging ---
    // This part is fine as is
    window.addEventListener('message', event => {
      console.log('Received message:', event.data);
      if (event.origin.includes('amaxinsurance.com') ||
          event.origin.includes('maxbi.')) {
        if (event.data.type === 'USER_AUTH' && event.data.user) {
          localStorage.setItem('amax_parent_user', JSON.stringify(event.data.user));
          console.log('Stored parent user data');
        }
      }
    });

    if (window.parent && window.parent !== window) {
      window.addEventListener('load', () => {
        window.parent.postMessage({ type: 'AMAX_WIDGET_READY', timestamp: Date.now() }, '*');
        console.log('Notified parent window of widget ready');
      });
    }

    console.log('Index.html script setup complete');
  </script>

  <script src="./amax-widget.js"></script>
</body>
</html>
