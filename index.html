<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AMAX BI Assistant</title>
  <meta name="description" content="AMAX Insurance Business Intelligence Assistant - AI-powered data analysis and reporting">
  <meta name="keywords" content="AMAX, insurance, business intelligence, AI assistant, data analysis">

  <!-- Security Headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="./assets/amax-logo-favi-icon.png">
  <link rel="shortcut icon" href="./assets/amax-logo-favi-icon.png">

  <style>
    /* Reset & page styling */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: transparent;
      min-height: 100vh;
      overflow: hidden;
    }
    .page-content { display: none; }

    /* iframe‑mode & loading/emergency UI */
    body.iframe-mode { position: relative; width: 100%; height: 100vh; }
    .emergency-button {
      position: fixed; bottom: 25px; right: 25px;
      width: 65px; height: 65px;
      background: linear-gradient(135deg, #DC143C 0%, #B91C1C 100%);
      border: none; border-radius: 50%;
      cursor: pointer; z-index: 999998;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 8px 32px rgba(220,20,60,0.4);
      transition: all .3s ease;
    }
    .emergency-button:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 12px 40px rgba(220,20,60,0.6);
    }
    .emergency-button img { width: 32px; height: 32px; object-fit: contain; }
    .widget-loaded .emergency-button { display: none !important; }

    .loading-indicator {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.9);
      padding: 20px; border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      z-index: 999997; display: none;
      text-align: center;
    }
    .loading-spinner {
      width: 24px; height: 24px;
      border: 2px solid #e5e7eb; border-top: 2px solid #DC143C;
      border-radius: 50%; animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin { 0% {transform:rotate(0);} 100% {transform:rotate(360deg);} }
    .widget-loaded .loading-indicator { display: none !important; }
  </style>
</head>

<body>
  <!-- Emergency fallback -->
  <button class="emergency-button" id="emergencyBtn" onclick="emergencyOpen()" title="Open AMAX BI Assistant">
    <img src="./assets/amax-logo-A.png" alt="AMAX" 
         onerror="this.style.display='none'; this.parentNode.innerHTML='A';">
  </button>

  <!-- Loading spinner -->
  <div class="loading-indicator" id="loadingIndicator">
    <div class="loading-spinner"></div>
    <div>Loading AMAX BI Assistant...</div>
  </div>

  <!-- Hidden SEO content -->
  <div class="page-content">
    <h1>AMAX Insurance BI Assistant</h1>
    <p>AI-powered business intelligence and data analysis for AMAX Insurance.</p>
  </div>

  <script>
    console.log('AMAX Index.html loading...');

    // iframe detection
    if (window.self !== window.top) {
      document.body.classList.add('iframe-mode');
      console.log('Running in iframe mode');
    }

    // Emergency button logic
    function emergencyOpen() {
      console.log('Emergency button clicked');
      const widgetBtn = document.getElementById('amaxWidgetBtn');
      if (widgetBtn) {
        widgetBtn.click();
        console.log('Found and clicked widget button');
      } else {
        console.log('Widget button not found, retrying...');
        setTimeout(emergencyOpen, 1000);
      }
    }

    // Widget load detection
    let widgetCheckAttempts = 0, maxAttempts = 10;
    function checkWidgetLoaded() {
      widgetCheckAttempts++;
      console.log(`Checking for widget… attempt ${widgetCheckAttempts}`);
      if (document.getElementById('amaxWidgetBtn')) {
        document.body.classList.add('widget-loaded');
        console.log('✅ Widget loaded successfully!');
      } else if (widgetCheckAttempts < maxAttempts) {
        setTimeout(checkWidgetLoaded, 1000);
      } else {
        console.log('❌ Widget failed to load');
        document.getElementById('loadingIndicator').style.display = 'block';
      }
    }
    window.addEventListener('load', () => {
      console.log('Page loaded, starting widget detection…');
      setTimeout(checkWidgetLoaded, 500);
    });

    // Parent ↔︎ widget messaging (if used)
    window.addEventListener('message', event => {
      console.log('Received message:', event.data);
      if (event.origin.includes('amaxinsurance.com') ||
          event.origin.includes('maxbi.')) {
        if (event.data.type === 'USER_AUTH' && event.data.user) {
          localStorage.setItem('amax_parent_user', JSON.stringify(event.data.user));
          console.log('Stored parent user data');
        }
      }
    });
    if (window.parent && window.parent !== window) {
      window.addEventListener('load', () => {
        window.parent.postMessage({ type: 'AMAX_WIDGET_READY', timestamp: Date.now() }, '*');
        console.log('Notified parent window of widget ready');
      });
    }

    console.log('Index.html script setup complete');
  </script>

  <!-- Your widget loader (this file lives at ./amax-widget.js) -->
  <script src="./amax-widget.js"></script>
</body>
</html>
